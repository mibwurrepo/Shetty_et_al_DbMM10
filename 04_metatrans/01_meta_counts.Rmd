---
title: "Metatranscriptomics analysis"
author: "Sudarshan A. Shetty"
date: "`r date()`"
output: 
  html_document: 
    toc: yes
    toc_depth: 2
    toc_float: true
    code_folding: hide  
editor_options: 
  chunk_output_type: console
---

The analysis here is based on triplicates.    
Read outputs of DIAMOND analysis into R. The code follows the R scripts from SAMSA2 pipeline.  
1. meta_counts  
  1.a strain specific volcano    
  1.b gene abundance analysis    



# Setup

```{r setup message=FALSE, warning=FALSE}
#rm(list = ls())
# import other necessary packages
suppressPackageStartupMessages({
  library(DESeq2)
  library(tidyverse)
  #library(EnhancedVolcano)
  library(ggplot2)
})

```

# Create sub directories  
```{r}
dir.create("01_meta_counts")
# create directory to save intermediate files as rds objects as well as save tables
dir.create("01_meta_counts/output")
dir.create("01_meta_counts/output/tables")
dir.create("01_meta_counts/output/rds")
#dir.create("01_meta_counts/output/figs")

```


# Read counts  

Input files here were obtained from SAMSA2 pipeline.
## Get file names  
```{r}
# GET FILE NAMES Control 24h
control_files <- list.files(pattern = "control_*", 
                            full.names = T, recursive = FALSE)

control_names = ""
for (name in control_files) {
  control_names <-
    c(control_names, unlist(strsplit(
      name, split = '_', fixed = TRUE
    ))[2])
}

control_names <- control_names[-1]
control_names_trimmed = ""
for (name in control_names) {
  control_names_trimmed <-
    c(control_names_trimmed, unlist(strsplit(
      name, split = '.', fixed = TRUE
    ))[1])
}

control_names_trimmed <- control_names_trimmed[-1]

# Experimental 48h

exp_files <- list.files(pattern = "experimental_*",
                        full.names = T,
                        recursive = FALSE)
exp_names = ""
for (name in exp_files) {
  exp_names <-
    c(exp_names, unlist(strsplit(
      name, split = '_', fixed = TRUE
    ))[2])
}
exp_names <- exp_names[-1]
exp_names_trimmed = ""
for (name in exp_names) {
  exp_names_trimmed <-
    c(exp_names_trimmed, unlist(strsplit(
      name, split = '.', fixed = TRUE
    ))[1])
}
exp_names_trimmed <- exp_names_trimmed[-1]

# sanity check
if (length(exp_files) == 0 || length(control_files) == 0) {
  print ("\nWARNING: No files found.  Is the directory correct?  Are the files named with 'control_' and 'experimental_' as prefixes?")
  stop()
}

#head(control_names_trimmed)
#head(exp_names_trimmed)

```

## Read files  

```{r}

# loading the control table
y <- 0
for (x in control_files) {
  y <- y + 1
  if (y == 1) {
    control_table <- read.table(file = x, header = F, quote = "", sep = "\t")
    colnames(control_table) = c(x, "V2")
    control_table <- control_table[,c(2,1)]      }
  if (y > 1) {
    temp_table <- read.table(file = x, header = F, quote = "", sep = "\t")
    colnames(temp_table) = c( x, "V2")
    temp_table <- temp_table[,c(1,2)]
    control_table <- merge(control_table, temp_table, by = "V2", all = T)  }
}

head(control_table)

control_table[is.na(control_table)] <- 0
rownames(control_table)= control_table$V2
 
control_table_trimmed <- data.frame(control_table[,-1])

# loading the experimental table
z <- 0
for (x in exp_files) {
  z <- z + 1
  if (z == 1) {
    exp_table <- read.table(file = x, header=F, quote = "", sep = "\t")
    colnames(exp_table) = c(x, "V2")
    exp_table <- exp_table[,c(2,1)]  }
  if (z > 1) {
    temp_table <- read.table(file = x, header = F, quote = "", sep = "\t")
    colnames(temp_table) = c(x, "V2")
    exp_table <- merge(exp_table, temp_table[,c(1,2)], by = "V2", all = T)  }
}
exp_table[is.na(exp_table)] <- 0
rownames(exp_table) = exp_table$V2
exp_table_trimmed <- exp_table[,-1]

```

Format the two tables.   
## Create main table  
```{r}

# getting the column names simplified
colnames(control_table_trimmed) = control_names_trimmed
colnames(exp_table_trimmed) = exp_names_trimmed

# merging the two tables (time-consuming step)
complete_table <- merge(control_table_trimmed, exp_table_trimmed, by=0, all = TRUE)
complete_table[is.na(complete_table)] <- 0
# reducing stuff down to avoid duplicates
complete_table <- aggregate(. ~  Row.names, data = complete_table, sum)

rownames(complete_table) <- complete_table$Row.names

complete_table <- complete_table[!(complete_table$Row.names == ""), ]

# removing extra Row.names column
complete_table <- complete_table[,-1]
complete_table.a <- complete_table
#colnames(complete_table.a)
#head(complete_table)
```


Store the complete table for later anlaysis.  

## Save objects  
```{r}

raw_counts_table <- complete_table
saveRDS(raw_counts_table, "01_meta_counts/output/rds/raw_counts_tables.rds")

write.table(raw_counts_table, "01_meta_counts/output/tables/raw_counts_tables.txt", col.names=NA, sep = "\t")

```

Here, the raw_counts_tables.rds contains locus tag counts in each sample.  

```{r}
sessionInfo()
```

