---
title: "Core microbiota anlaysis from metagenomic data"
author: "Sudarshan"
date: "29 July 2019"
output: html_document
---
  
In this document we investigate the human gut metagenomics data to identify core species.  

## Setup
Load libraries  

```{r, warning=FALSE, message=FALSE}

#library(BiocInstaller)
#biocLite("curatedMetagenomicData")
library(RColorBrewer)
library(curatedMetagenomicData)
library(microbiome)
library(microbiomeutilities)
library(ggpubr)
library(dplyr)
```


## Download public metagenomic data  

Download the datasets for gut metagenomes from the `curatedMD` R package.  


```{r}

#eh = ExperimentHub()
#myquery = query(eh, "curatedMetagenomicData")
# myquery
# View(mcols(myquery))

hmp.eset <- HMP_2012.metaphlan_bugs_list.stool()
#lecha.eset <- LeChatelierE_2013.metaphlan_bugs_list.stool()
loman.eset <- LomanNJ_2013.metaphlan_bugs_list.stool()
nielsenHB.eset <- NielsenHB_2014.metaphlan_bugs_list.stool()
obregon.eset <- `Obregon-TitoAJ_2015.metaphlan_bugs_list.stool`()
#qinN.eset <- QinN_2014.metaphlan_bugs_list.stool()
rampel.eset <- RampelliS_2015.metaphlan_bugs_list.stool()
zeller.eset <- ZellerG_2014.metaphlan_bugs_list.stool()
qinj.eset <- QinJ_2012.metaphlan_bugs_list.stool()
hann.eset <- HanniganGD_2017.metaphlan_bugs_list.stool()
beng.eset <- `Bengtsson-PalmeJ_2015.metaphlan_bugs_list.stool`()
louis.eset <- LouisS_2016.metaphlan_bugs_list.stool()
schir.eset <- SchirmerM_2016.metaphlan_bugs_list.stool()

```


## Convert to phyloseq object   

```{r}

hmp.pseq1 = ExpressionSet2phyloseq( hmp.eset, relab=FALSE)
#lecha.pseq1 = ExpressionSet2phyloseq( lecha.eset, relab=FALSE)
loman.pseq1 = ExpressionSet2phyloseq( loman.eset, relab=FALSE)
neil.pseq1 = ExpressionSet2phyloseq( nielsenHB.eset, relab=FALSE)
obregon.pseq1 = ExpressionSet2phyloseq( obregon.eset, relab=FALSE)
#qinN.pseq1 = ExpressionSet2phyloseq( qinN.eset, relab=FALSE)
rampel.pseq1 = ExpressionSet2phyloseq( rampel.eset, relab=FALSE)
zeller.pseq1 = ExpressionSet2phyloseq( zeller.eset, relab=FALSE)
qinj.pseq1 = ExpressionSet2phyloseq( qinj.eset, relab=FALSE)
hann.est.pseq1 = ExpressionSet2phyloseq(hann.eset, relab=FALSE)
beng.eset.pseq1 = ExpressionSet2phyloseq(beng.eset, relab=FALSE)
louis.eset.pseq1 = ExpressionSet2phyloseq(louis.eset, relab=FALSE)
schir.eset.pseq1 = ExpressionSet2phyloseq(schir.eset, relab=FALSE)


table(meta(schir.eset.pseq1)$country)
table(meta(hann.est.pseq1)$disease)
```


## Select non-diseased samples    

```{r}

unique(meta(neil.pseq1)$disease)


neil.pseq1 <- subset_samples(neil.pseq1, disease == "healthy")

unique(meta(obregon.pseq1)$disease)
obregon.pseq1 <- subset_samples(obregon.pseq1, disease == "healthy")

#unique(meta(qinN.pseq1)$disease)
#qinN.pseq1 <- subset_samples(qinN.pseq1, disease == "n")

unique(meta(rampel.pseq1)$study_condition)
rampel.pseq1 <- subset_samples(rampel.pseq1, study_condition == "control")

hann.pseq1 <- subset_samples(hann.est.pseq1, disease == "healthy")

unique(meta(zeller.pseq1)$disease)
zeller.pseq1 <- subset_samples(zeller.pseq1, disease == "healthy")


unique(meta(qinj.pseq1)$disease)
qinj.pseq1 <- subset_samples(qinj.pseq1, is.na(disease))

```


```{r, eval=FALSE}

hmp.pseq1 <- prune_taxa(taxa_sums(hmp.pseq1) > 0, hmp.pseq1)
#lecha.pseq1 <- prune_taxa(taxa_sums(lecha.pseq1) > 0, lecha.pseq1)
neil.pseq1 <- prune_taxa(taxa_sums(neil.pseq1) > 0, neil.pseq1)
obregon.pseq1 <- prune_taxa(taxa_sums(obregon.pseq1) > 0, obregon.pseq1)
#qinN.pseq1 <- prune_taxa(taxa_sums(qinN.pseq1) > 0, qinN.pseq1)
rampel.pseq1 <- prune_taxa(taxa_sums(rampel.pseq1) > 0, rampel.pseq1)
zeller.pseq1 <- prune_taxa(taxa_sums(zeller.pseq1) > 0, zeller.pseq1)
qinj.pseq1 <- prune_taxa(taxa_sums(qinj.pseq1) > 0, qinj.pseq1)
hannpseq1 = prune_taxa(taxa_sums(hann.pseq1) > 0, hann.pseq1)
beng.pseq1 = prune_taxa(taxa_sums(beng.eset.pseq1) > 0, beng.eset.pseq1)
louis.pseq1 = prune_taxa(taxa_sums(louis.eset.pseq1) > 0, louis.eset.pseq1)
schir.pseq1 = prune_taxa(taxa_sums(schir.eset.pseq1) > 0, schir.eset.pseq1)


```

## Merge all data

```{r, eval=FALSE}


ps0a <- merge_phyloseq(hmp.pseq1,neil.pseq1,obregon.pseq1, 
                       rampel.pseq1,zeller.pseq1,qinj.pseq1,
                       hannpseq1,beng.pseq1,louis.pseq1,schir.pseq1)

table(meta(ps0a)$country)
table(meta(ps0a)$disease)

saveRDS(ps0a, "output/rds/ps1_raw_metagenome.rds")
```


## Clean and filter  
```{r}

ps0a <- readRDS("output/rds/ps1_raw_metagenome.rds")

ps0b <- subset_samples(ps0a, country != "CHN") %>% subset_samples(country != "PER") %>% subset_samples(country != "TZA")

ps0c <- subset_taxa(ps0b, Kingdom == "Bacteria")

any(taxa_sums(ps0c) < 1)

ps0d <- prune_taxa(taxa_sums(ps0c) > 1, ps0c)

any(taxa_sums(ps0d) < 1)

ps0e <- subset_taxa(ps0d, !is.na(Species))

ps1a <- tax_glom(ps0e, "Species") # time consuming step

saveRDS(ps1a, "output/rds/ps1a_taxglom_species.rds")


```

```{r}

ps1a <- readRDS("output/rds/ps1a_taxglom_species.rds")
any(taxa_sums(ps1a) == 1)

table(meta(ps1a)$country,meta(ps1a)$country)
table(meta(ps1a)$disease)
```



```{r}

ps1a.west <- microbiome::transform(ps1a, "compositional")

#head(otu_table(ps1a.west))

min(taxa_sums(ps1a.west))

# final study detail
ps1a.west
#head(meta(ps1a.west))
table(meta(ps1a.west)$disease)
table(meta(ps1a.west)$country)
nsamples(ps1a.west)
```
CAN DEU DNK ESP FRA ITA NLD SWE USA 
  3  97 177  71  61  11 471  70 194 
  
healthy 
   1144 

## Core anlaysis  

```{r}

prevalences <- seq(.05, 1, .05)
detections <- 10^seq(log10(1e-5), log10(.2), length = 10)
ps1a.core <- plot_core(ps1a.west, plot.type = "heatmap", 
                       prevalences = prevalences,
                       detections = detections,
                       colours = rev(brewer.pal(9, "RdBu")),
                       min.prevalence = .50, 
                       horizontal = F)

ps1a.core


```

Let's clean this figure.

```{r}

ps.df <- ps1a.core$data

#unique(newdata$Taxa)

head(ps.df)
#ps.df$Prevalence
newdata <- ps.df[order(ps.df$Prevalence),] 

newdata$Taxa <- gsub("s__", "", newdata$Taxa)
head(newdata)
ps1a.core$data <- newdata


p <- ggplot(newdata, aes(x=DetectionThreshold, reorder(Taxa, Prevalence), fill=Prevalence))
p <- p + geom_tile(order =TRUE) + theme(axis.text.y = element_text(face="italic"))
p <- p + xlab("Detection Threshold (Relative Abundance)") + ylab("Metagenomic species")
p.core <- p + scale_x_log10() + 
  scale_fill_gradientn(colours = rev(brewer.pal(5, "RdBu"))) +
  theme_bw(base_size=10) + ggtitle(paste0("Metagenomics Core Microbiota n= ", nsamples(ps1a.west), " (stool)")) + theme(axis.text.y = element_text(face="italic"))
print(p.core)

#ggsave("./figures/core_microbiota_Species_West_metagenome_microbiome_75_1.tiff", height = 6, width = 6)
#ggsave("./figures/core_microbiota_Species_West_metagenome_microbiome75_1.pdf", height = 6, width = 6)

p.core <- p.core + scale_y_discrete(labels=c("Lachnospiraceae_bacterium_7_1_58FAA"=expression(bolditalic(Lachnospiraceae_bacterium_7_1_58FAA)),
                                             "Coprococcus_catus"=expression(bolditalic(Coprococcus_catus)),
                                             "Eubacterium_hallii"=expression(bolditalic(Eubacterium_hallii)), 
                                             "Bacteroides_xylanisolvens" = expression(bolditalic(Bacteroides_xylanisolvens)),
                                             "Roseburia_intestinalis" = expression(bolditalic(Roseburia_intestinalis)),
                                             "Eubacterium_siraeum" = expression(bolditalic(Eubacterium_siraeum)), 
                                             "Bacteroides_ovatus" = expression(bolditalic(Bacteroides_ovatus)),
                                             "Subdoligranulum_unclassified" = expression(bolditalic(Subdoligranulum_unclassified)),
                                             "Faecalibacterium_prausnitzii" = expression(bolditalic(Faecalibacterium_prausnitzii)),
                                             "Eubacterium_rectale" = expression(bolditalic(Eubacterium_rectale)), 
                                             parse=TRUE)) 

p.core 
sink(file="output/tables/01_core_species.txt")
unique(p.core$data$Taxa)
sink()


ggsave("output/figs/01_core_microbiota_species.tiff", height = 6, width = 6)
ggsave("output/figs/01_core_microbiota_species.pdf", height = 6, width = 6)

write.csv(newdata, "output/tables/01_Species_level_Core_micoribotaWest.csv")
```



# Realtive abundance-occupancy
```{r}
otu.abun = apply(otu_table(ps1a.west),1,mean)

# Calculate the frequency of each OTU across all samples
# 
otu.freq = rowSums(otu_table(ps1a.west) != 0)/nsamples(ps1a.west)

# Reassign names of phyla so we only color by the top 5 phyla and mark all others as "other"
unique(tax_table(ps1a.west)[,2])
phy <- tax_table(ps1a.west)[,2]
phyla <- phy[,"Phylum"]
#phyla = as.vector(data.frame(tax_table(ps1a.west))$Phylum)

levels(phyla) = c(levels(phyla),"other")
keephyla = c("Actinobacteria","Bacteroidetes","Firmicutes", "Proteobacteria","Verrucomicrobia")
phyla[!(phyla %in% keephyla)] = "Other"
phyla = as.vector(phyla)
phyla=as.factor(phyla)

otuabun = data.frame(abundance= otu.abun,Frequency=otu.freq,phyla)

# Use color brewer to pick a color scheme for the phyla
brew = brewer.pal(7, "Paired")

# Create a scatterplot of OTUs showing their average relative abundance and frequency 
# This plot shows how rare and abundant OTUs are distributed across the
# your study.

write.csv(otuabun, "Ocucpancy_relationship.csv")
p.occ <- ggplot(otuabun, aes(x= 100*(abundance),y=Frequency,color=phyla)) + geom_point(aes(size = Frequency), shape = 21, stroke = 1, alpha = 0.6) +
    xlab("Average relative abundance (%)") + 
    ylab("OTU frequency in gut metagenomes") + 
    scale_colour_brewer("Phylum",palette="Dark2") +
    theme_bw() + geom_vline(xintercept = 0, linetype="dashed", color = "grey")

# now add species
p.occ$data$species <- rownames(p.occ$data)

p.occ$data$species <- gsub("s__", "", p.occ$data$species)

write.csv(otuabun, "Ocucpancy_relationship.csv")

mmsp <- c("Coprococcus_catus","Lachnospiraceae_bacterium_7_1_58FAA","Eubacterium_hallii","Bacteroides_xylanisolvens", "Roseburia_intestinalis","Eubacterium_siraeum","Bacteroides_ovatus","Subdoligranulum_unclassified", "Faecalibacterium_prausnitzii","Eubacterium_rectale")

p.occ2 <- p.occ + ggrepel::geom_text_repel(segment.color = "grey50", aes(label = species, fontface=3), 
                                           data = p.occ$data[p.occ$data$species %in% mmsp,], 
                                           color = "black", size = 4,
                                           arrow = arrow(length = unit(0.02, "npc")), 
                                           box.padding = 1.5,
                                           nudge_x = 0.05) 

p.occ2

ggsave("output/figs/01_RelAb_Occupancy_Abundance_relationship.tiff", height = 6, width = 10)
ggsave("output/figs/01_RelAb_Occupancy_Abundance_relationship.pdf", height = 6, width = 10)


ggarrange(p.core, p.occ2, labels = c("a", "b"), ncol = 2)

ggsave("output/figs/01_Figure_1_RelAb_Occupancy_Abundance_relationship.pdf", height = 8, width = 18)
ggsave("output/figs/01_Figure_1_RelAb_Occupancy_Abundance_relationship.tiff", height = 8, width = 18)
ggsave("output/figs/01_Figure_1_RelAb_Occupancy_Abundance_relationship.pdf", height = 8, width = 18)

```



```{r}
core.ps1 <- core(ps1a.west, detection = 0.00001, prevalence = 0.5)

core.mem <- core_members(ps1a.west, detection = 0.0001, prevalence = 0.5)

ps.core <- prune_taxa(core.mem, ps1a)

otu.c <- t(otu_table(ps.core)@.Data) #extract the otu table from phyloseq object

min(sample_sums(ps.core))

correlation.table <- associate(otu.c, otu.c, method = "spearman", mode = "table", p.adj.threshold = 0.05, n.signif = 1)
p <- heat(correlation.table, "X1", "X2", fill = "Correlation", star = "p.adj", p.adj.threshold = 0.05,
          colours = brewer.pal(8, 'RdBu')) 
p + theme_bw(base_size = 10) + rotate_x_text() 

ggsave("output/figs/01_Figure_S1_correlation_relationship.pdf", height = 8, width = 8)
```


```{r}
sessionInfo()

```



